<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Money Tracker</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .slide-in { animation: slideIn 0.3s ease-out forwards; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .vip-card-selected { border: 2px solid #d97706; background-color: #fffbeb; }
        .loader { width: 16px; height: 16px; border: 2px solid #f3f3f3; border-top: 2px solid #3b82f6; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbxI1uxUAE76Z5QFi-8HRcNB6BvameBiHtmxRwirpCykv-5TatHOi2ssVMtqX8Gp6bSv/exec"; 
        
        const ADMIN_EMAIL = "minhtre2609@gmail.com";

        const REAL_API = {
            checkUrl: () => {
                if (!GAS_API_URL || GAS_API_URL.length < 10) { 
                    alert("LỖI: Bạn chưa dán link Google Apps Script vào biến GAS_API_URL trong code!");
                    return false; 
                }
                return true;
            },
            call: async (payload) => {
                if (!REAL_API.checkUrl()) throw new Error("Chưa cấu hình API URL");
                
                try {
                    const res = await fetch(GAS_API_URL, {
                        method: 'POST', redirect: "follow",
                        headers: { "Content-Type": "text/plain;charset=utf-8" },
                        body: JSON.stringify(payload)
                    });
                    
                    const data = await res.json();
                    if (data.status === 'success') return data;
                    throw new Error(data.message || "Lỗi xử lý từ Server");
                } catch (err) {
                    console.error("API Error:", err);
                    if (err.name === 'TypeError' && err.message.includes('fetch')) {
                        throw new Error("Lỗi kết nối! Vui lòng kiểm tra:\n1. Link API có đúng không?\n2. Bạn đã chọn quyền 'Anyone' (Bất kỳ ai) khi Deploy chưa?");
                    }
                    throw err;
                }
            },
            login: async (email, password) => (await REAL_API.call({ action: 'login', email, password })).user,
            register: async (name, email, password, tier) => (await REAL_API.call({ action: 'register', name, email, password, tier })).user,
            changePassword: async (email, newPassword) => await REAL_API.call({ action: 'change_password', email, newPassword }),
            addTransaction: async (user, transaction) => await REAL_API.call({ action: 'add_transaction', email: user.email, tier: user.tier, transaction }),
            getTransactions: async (email) => (await REAL_API.call({ action: 'get_transactions', email })).transactions || [],
            deleteTransaction: async (email, id) => await REAL_API.call({ action: 'delete_transaction', email, id }),
            getAllUsers: async (adminEmail) => (await REAL_API.call({ action: 'get_all_users', adminEmail })).users,
            updateUserTier: async (adminEmail, targetEmail, newTier) => await REAL_API.call({ action: 'update_user_tier', adminEmail, targetEmail, newTier })
        };

        // --- COMPONENTS ---
        const Icon = ({ name, size = 20, className = "" }) => {
            const icons = {
                home: <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" />,
                plus: <path d="M12 5v14M5 12h14" />,
                clock: <circle cx="12" cy="12" r="10" />,
                settings: <circle cx="12" cy="12" r="3" />,
                trash: <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />,
                pie: <path d="M21.21 15.89A10 10 0 1 1 8 2.83M22 12A10 10 0 0 0 12 2v10z" />,
                refresh: <path d="M23 4v6h-6M1 20v-6h6" />,
                user: <><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></>,
                lock: <><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></>,
                key: <><circle cx="7.5" cy="15.5" r="5.5"/><path d="m21 2-9.6 9.6"/><path d="m15.5 7.5 3 3L22 7l-3-3"/></>,
                crown: <path d="M2 4l3 12h14l3-12-6 7-4-7-4 7-6-7zm3 16h14"></path>,
                logout: <><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></>,
                x: <path d="M18 6 6 18M6 6l12 12"></path>,
                shield: <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>,
                check: <polyline points="20 6 9 17 4 12"></polyline>,
                calendar: <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>,
                info: <circle cx="12" cy="12" r="10"></circle>,
                copy: <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
            };
            return <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{icons[name] || <circle cx="12" cy="12" r="10"/>}</svg>;
        };

        const formatCurrency = (n) => new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(n);
        const formatDateTime = (d) => !d ? '' : new Date(d).toLocaleString('vi-VN', { hour: '2-digit', minute: '2-digit', day: '2-digit', month: '2-digit', year: 'numeric' });
        const getCurrentDateTimeLocal = () => { 
            const n=new Date(); 
            n.setMinutes(n.getMinutes()-n.getTimezoneOffset()); 
            return n.toISOString().slice(0,16); 
        };

        // --- Modals ---
        const QRModal = ({ email, onClose, onConfirm }) => (
            <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4 backdrop-blur-sm slide-in">
                <div className="bg-white rounded-2xl w-full max-w-sm overflow-hidden shadow-2xl relative">
                    <button onClick={onClose} className="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><Icon name="x" size={24}/></button>
                    <div className="bg-yellow-50 p-6 text-center border-b border-yellow-100">
                        <h3 className="font-bold text-xl text-yellow-800">Thanh toán VIP</h3>
                        <p className="text-sm text-yellow-600 mt-1">Mở khóa chức năng tích hợp Google Calendar</p>
                    </div>
                    <div className="p-6 flex flex-col items-center">
                        <img src={`https://img.vietqr.io/image/bidv-4506521679-compact.jpg?amount=50000&addInfo=Nang cap VIP ${email}&accountName=PHAN NHAT MINH`} alt="QR" className="w-48 h-48 object-contain bg-white p-2 rounded-lg border mb-4" />
                        <p className="font-bold text-lg">50.000đ</p>
                        <div className="bg-blue-50 p-3 rounded-lg text-xs text-blue-700 text-center w-full mb-4 mt-2">Nội dung: <span className="font-bold font-mono">Nang cap VIP {email}</span></div>
                        <button onClick={onConfirm} className="w-full py-3 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 transition">Tôi đã chuyển khoản</button>
                    </div>
                </div>
            </div>
        );

        // --- Guide Modal ---
        const GuideModal = ({ onClose }) => (
            <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4 backdrop-blur-sm slide-in">
                <div className="bg-white rounded-2xl w-full max-w-md overflow-hidden shadow-2xl relative max-h-[90vh] overflow-y-auto">
                    <button onClick={onClose} className="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><Icon name="x" size={24}/></button>
                    <div className="p-6 border-b">
                        <h3 className="font-bold text-xl text-gray-800 flex items-center gap-2"><Icon name="calendar" className="text-blue-600"/> Kết nối Google Calendar</h3>
                    </div>
                    <div className="p-6 space-y-4 text-sm text-gray-600">
                        <p>Để ứng dụng tự động thêm sự kiện vào Lịch của bạn, bạn cần chia sẻ quyền chỉnh sửa cho Admin.</p>
                        <div className="bg-gray-50 p-4 rounded-xl border border-gray-200">
                            <div className="font-bold text-gray-800 mb-2">Bước 1: Copy email Admin</div>
                            <div className="flex items-center gap-2 bg-white p-2 rounded border border-gray-300">
                                <code className="flex-1 text-xs truncate">{ADMIN_EMAIL}</code>
                                <button onClick={() => { navigator.clipboard.writeText(ADMIN_EMAIL); alert("Đã copy!"); }} className="text-blue-600 p-1 hover:bg-blue-50 rounded"><Icon name="copy" size={16}/></button>
                            </div>
                        </div>
                        <div className="space-y-2">
                            <div className="font-bold text-gray-800">Bước 2: Cài đặt chia sẻ</div>
                            <ul className="list-disc pl-5 space-y-1">
                                <li>Mở <b>Google Calendar</b> trên web/máy tính.</li>
                                <li>Di chuột vào Lịch của bạn ở cột trái -> Bấm dấu 3 chấm -> <b>Cài đặt và chia sẻ</b>.</li>
                                <li>Kéo xuống mục <b>"Chia sẻ với những người cụ thể"</b>.</li>
                                <li>Bấm <b>"Thêm người"</b> và dán email Admin vào.</li>
                                <li>Ở mục Quyền, chọn: <b>"Thay đổi sự kiện"</b> (Make changes to events).</li>
                                <li>Bấm Gửi.</li>
                            </ul>
                        </div>
                        <div className="bg-green-50 text-green-800 p-3 rounded-lg text-xs">Xong! Từ giờ khi bạn thêm giao dịch, nó sẽ tự động hiện trên lịch của bạn.</div>
                        <button onClick={onClose} className="w-full py-3 bg-gray-100 text-gray-700 font-bold rounded-xl hover:bg-gray-200">Đã hiểu</button>
                    </div>
                </div>
            </div>
        );

        // --- Auth Component ---
        const AuthScreen = ({ onLogin }) => {
            const [isLogin, setIsLogin] = useState(true);
            const [form, setForm] = useState({ email: '', password: '', name: '', tier: 'free' });
            const [loading, setLoading] = useState(false);
            const [msg, setMsg] = useState('');
            const [showQR, setShowQR] = useState(false);

            const handleReg = async (e) => { e.preventDefault(); form.tier==='vip' ? setShowQR(true) : doReg('free'); };
            const doReg = async (tier) => { setLoading(true); setMsg(''); try { const u = await REAL_API.register(form.name,form.email,form.password,tier); onLogin(u); } catch(e){setMsg(e.message);setLoading(false);} };
            const handleLog = async (e) => { e.preventDefault(); setLoading(true); setMsg(''); try { const u = await REAL_API.login(form.email,form.password); onLogin(u); } catch(e){setMsg(e.message);setLoading(false);} };

            return (
                <div className="min-h-screen flex items-center justify-center bg-gray-100 p-4">
                    {showQR && <QRModal email={form.email} onClose={()=>setShowQR(false)} onConfirm={()=>{setShowQR(false);doReg('pending');}} />}
                    <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md slide-in">
                        <h1 className="text-2xl font-bold text-center mb-6 text-gray-800">Money Tracker</h1>
                        <form onSubmit={isLogin?handleLog:handleReg} className="space-y-4">
                            {!isLogin && <input type="text" placeholder="Họ tên" className="w-full p-3 border rounded-lg" required onChange={e=>setForm({...form,name:e.target.value})}/>}
                            <input type="email" placeholder="Email" className="w-full p-3 border rounded-lg" required onChange={e=>setForm({...form,email:e.target.value})}/>
                            <input type="password" placeholder="Mật khẩu" className="w-full p-3 border rounded-lg" required onChange={e=>setForm({...form,password:e.target.value})}/>
                            {!isLogin && <div className="grid grid-cols-2 gap-3"><div onClick={()=>setForm({...form,tier:'free'})} className={`p-3 border rounded-xl text-center cursor-pointer ${form.tier==='free'?'border-blue-500 bg-blue-50':''}`}>Free</div><div onClick={()=>setForm({...form,tier:'vip'})} className={`p-3 border rounded-xl text-center cursor-pointer ${form.tier==='vip'?'vip-card-selected':''}`}>VIP (50k)</div></div>}
                            {msg && <div className="text-red-500 text-sm text-center">{msg}</div>}
                            <button disabled={loading} className="w-full py-3 bg-blue-600 text-white rounded-lg font-bold disabled:opacity-50 flex justify-center">{loading?<span className="loader"></span>:(isLogin?'Đăng nhập':'Đăng ký')}</button>
                        </form>
                        <p className="text-center mt-4 text-sm text-blue-600 cursor-pointer hover:underline" onClick={()=>setIsLogin(!isLogin)}>{isLogin?'Tạo tài khoản mới':'Quay lại đăng nhập'}</p>
                    </div>
                </div>
            );
        };

        // --- Admin Tab ---
        const AdminTab = ({ adminUser }) => {
            const [users, setUsers] = useState([]);
            const [loading, setLoading] = useState(false);
            useEffect(() => { loadUsers(); }, []);
            const loadUsers = async () => { setLoading(true); try { setUsers(await REAL_API.getAllUsers(adminUser.email)); } catch(e){alert(e.message)} finally { setLoading(false); } };
            const updateTier = async (target, tier) => { if(!confirm("Xác nhận?")) return; setLoading(true); try { await REAL_API.updateUserTier(adminUser.email, target, tier); loadUsers(); } catch(e){alert(e.message);setLoading(false);} };

            return (
                <div className="slide-in space-y-6">
                    <div className="flex justify-between items-center"><h2 className="text-2xl font-bold">Quản lý người dùng</h2><button onClick={loadUsers} className="p-2 rounded-full bg-gray-100 hover:bg-gray-200"><Icon name="refresh"/></button></div>
                    <div className="bg-white rounded-xl shadow-sm overflow-hidden border border-gray-100"><div className="overflow-x-auto"><table className="w-full text-left text-sm"><thead className="bg-gray-50 border-b font-semibold text-gray-600"><tr><th className="p-4">Email</th><th className="p-4">Tên</th><th className="p-4">Trạng thái</th><th className="p-4 text-right">Hành động</th></tr></thead><tbody className="divide-y">{users.map(u=><tr key={u.email} className="hover:bg-gray-50"><td className="p-4 font-medium">{u.email}</td><td className="p-4 text-gray-600">{u.name}</td><td className="p-4"><span className={`px-2 py-1 rounded text-xs font-bold ${u.tier==='admin'?'bg-purple-100 text-purple-700':u.tier==='vip'?'bg-yellow-100 text-yellow-700':u.tier==='pending'?'bg-orange-100 text-orange-700':'bg-gray-100 text-gray-600'}`}>{u.tier.toUpperCase()}</span></td><td className="p-4 text-right">{u.tier==='pending'&&<button onClick={()=>updateTier(u.email,'vip')} className="bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600 text-xs font-bold">Duyệt VIP</button>}{u.tier==='free'&&<button onClick={()=>updateTier(u.email,'vip')} className="text-blue-600 hover:underline text-xs">Lên VIP</button>}{u.tier==='vip'&&<button onClick={()=>updateTier(u.email,'free')} className="text-red-500 hover:underline text-xs">Hạ Free</button>}</td></tr>)}</tbody></table></div></div>
                </div>
            );
        };

        // --- Account Tab ---
        const AccountTab = ({ user, setUser, onLogout }) => {
            const [passModal, setPassModal] = useState(false);
            const [qrModal, setQrModal] = useState(false);
            const [guideModal, setGuideModal] = useState(false); 
            const [newPass, setNewPass] = useState('');
            const [loading, setLoading] = useState(false);

            const handleChangePass = async (e) => { e.preventDefault(); setLoading(true); try { await REAL_API.changePassword(user.email,newPass); alert("Thành công!"); setPassModal(false); } catch(e){alert(e.message);} finally{setLoading(false);} };

            return (
                <div className="bg-white p-8 rounded-2xl shadow-lg border border-gray-100 max-w-lg mx-auto slide-in">
                    {qrModal && <QRModal email={user.email} onClose={()=>setQrModal(false)} onConfirm={()=>{alert("Đã gửi!"); setQrModal(false);}} />}
                    {guideModal && <GuideModal onClose={()=>setGuideModal(false)} />} 
                    
                    <div className="flex items-center gap-5 mb-8 pb-6 border-b border-gray-100">
                        <div className={`w-20 h-20 rounded-full flex items-center justify-center text-3xl font-bold text-white shadow-md ${user.tier==='vip'||user.tier==='admin' ? 'bg-gradient-to-br from-yellow-400 to-orange-500' : 'bg-gradient-to-br from-blue-400 to-blue-600'}`}>{user.name.charAt(0).toUpperCase()}</div>
                        <div>
                            <h3 className="text-2xl font-bold text-gray-800">{user.name}</h3>
                            <p className="text-sm text-gray-500 mb-2">{user.email}</p>
                            {(user.tier === 'vip' || user.tier === 'admin') ? <span className={`px-3 py-1 rounded-full text-xs font-bold flex items-center gap-1 w-fit ${user.tier==='admin'?'bg-purple-100 text-purple-700':'bg-yellow-100 text-yellow-700'}`}><Icon name={user.tier==='admin'?'shield':'crown'} size={14}/> {user.tier.toUpperCase()}</span> : <span className="bg-gray-100 text-gray-600 px-3 py-1 rounded-full text-xs font-bold">FREE MEMBER</span>}
                        </div>
                    </div>

                    <div className="space-y-4">
                        {(user.tier === 'vip' || user.tier === 'admin') && (
                            <button onClick={()=>setGuideModal(true)} className="w-full flex items-center gap-4 p-4 rounded-xl bg-blue-50 border border-blue-100 hover:bg-blue-100 transition group text-left">
                                <div className="bg-white p-2 rounded-lg"><Icon name="calendar" size={20} className="text-blue-600"/></div>
                                <div className="flex-1"><span className="font-bold text-blue-800 block">Đồng bộ Lịch</span><span className="text-xs text-blue-600">Xem hướng dẫn kết nối</span></div>
                                <span className="text-blue-400 text-lg">›</span>
                            </button>
                        )}

                        <button onClick={()=>setPassModal(true)} className="w-full flex items-center gap-4 p-4 rounded-xl border border-gray-100 hover:bg-gray-50 hover:shadow-sm transition group text-left"><div className="bg-gray-100 p-2 rounded-lg group-hover:bg-white transition"><Icon name="key" size={20} className="text-gray-600"/></div><span className="font-medium text-gray-700">Đổi mật khẩu</span></button>
                        {user.tier === 'free' && <button onClick={()=>setQrModal(true)} className="w-full flex items-center gap-4 p-4 rounded-xl bg-gradient-to-r from-yellow-50 to-orange-50 border border-yellow-100 hover:shadow-md transition group text-left"><div className="bg-white p-2 rounded-lg"><Icon name="crown" size={20} className="text-yellow-600"/></div><div className="flex-1"><span className="font-bold text-yellow-800 block">Nâng cấp VIP</span><span className="text-xs text-yellow-600">Mở khóa tính năng nâng cao</span></div><span className="bg-white text-yellow-700 text-xs font-bold px-2 py-1 rounded">50k</span></button>}
                        {user.tier === 'pending' && <div className="w-full p-4 rounded-xl bg-orange-50 border border-orange-200 text-orange-700 text-sm flex items-center gap-2"><Icon name="clock"/> Đang chờ duyệt VIP...</div>}
                        <button onClick={onLogout} className="w-full flex items-center gap-4 p-4 rounded-xl bg-red-50 border border-red-100 hover:bg-red-100 text-red-600 transition mt-4 text-left"><div className="bg-white/50 p-2 rounded-lg"><Icon name="logout" size={20}/></div><span className="font-bold">Đăng xuất</span></button>
                    </div>

                    {passModal && <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4"><div className="bg-white p-6 rounded-2xl w-full max-w-sm shadow-2xl"><h3 className="font-bold text-lg mb-4 text-gray-800">Đổi mật khẩu</h3><form onSubmit={handleChangePass} className="space-y-4"><input type="password" placeholder="Nhập mật khẩu mới" className="w-full p-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" required value={newPass} onChange={e=>setNewPass(e.target.value)}/><div className="flex gap-3 pt-2"><button type="button" onClick={()=>setPassModal(false)} className="flex-1 py-2 bg-gray-100 text-gray-600 font-medium rounded-xl hover:bg-gray-200">Hủy</button><button type="submit" disabled={loading} className="flex-1 py-2 bg-blue-600 text-white font-bold rounded-xl hover:bg-blue-700">{loading?'Lưu...':'Lưu'}</button></div></form></div></div>}
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(() => JSON.parse(localStorage.getItem('user')));
            const [trans, setTrans] = useState([]);
            const [tab, setTab] = useState('dashboard');
            const [loading, setLoading] = useState(false);
            const [input, setInput] = useState({ amount: '', desc: '', type: 'expense', category: 'khac', date: getCurrentDateTimeLocal() });
            const [chartType, setChartType] = useState('expense');
            const chartRef = useRef(null);
            const chartInstance = useRef(null);

            const navItems = [{id: 'dashboard', label: 'Tổng quan', icon: 'pie'}, {id: 'add', label: 'Thêm mới', icon: 'plus'}, {id: 'history', label: 'Lịch sử', icon: 'clock'}, {id: 'account', label: 'Tài khoản', icon: 'user'}];
            if (user && user.tier === 'admin') navItems.push({id: 'admin', label: 'Admin', icon: 'shield'});

            const CATEGORIES = { expense: [{id:'anuong',label:'Ăn uống',color:'#ef4444',keywords:['cafe']},{id:'dichuyen',label:'Di chuyển',color:'#f97316',keywords:['xăng']},{id:'muasam',label:'Mua sắm',color:'#f59e0b',keywords:['quần']},{id:'hoadon',label:'Hóa đơn',color:'#84cc16',keywords:['điện']},{id:'giaitri',label:'Giải trí',color:'#06b6d4',keywords:['phim']},{id:'suckhoe',label:'Sức khỏe',color:'#8b5cf6',keywords:['thuốc']},{id:'khac',label:'Khác',color:'#64748b',keywords:[]}], income: [{id:'luong',label:'Lương',color:'#10b981',keywords:['lương']},{id:'thuong',label:'Thưởng',color:'#3b82f6',keywords:['thưởng']},{id:'dautu',label:'Đầu tư',color:'#6366f1',keywords:['lãi']},{id:'khac_in',label:'Khác',color:'#8b5cf6',keywords:[]}] };

            useEffect(() => { if(user) { localStorage.setItem('user', JSON.stringify(user)); loadData(); } else { localStorage.removeItem('user'); setTrans([]); } }, [user]);
            useEffect(() => { if(!input.desc) return; const list = input.type === 'expense' ? CATEGORIES.expense : CATEGORIES.income; const found = list.find(c => c.keywords.some(k => input.desc.toLowerCase().includes(k))); if(found) setInput(prev => ({...prev, category: found.id})); }, [input.desc, input.type]);

            const currentMonth = new Date();
            const processedData = useMemo(() => { let openingBalance = 0; let currentMonthTrans = []; trans.forEach(t => { const tDate = new Date(t.date); if(isNaN(tDate.getTime())) return; const isSameMonth = tDate.getMonth() === currentMonth.getMonth() && tDate.getFullYear() === currentMonth.getFullYear(); if (isSameMonth) currentMonthTrans.push(t); else if (tDate < currentMonth) { if (t.type === 'income') openingBalance += t.amount; else openingBalance -= t.amount; } }); const monthIn = currentMonthTrans.filter(t => t.type === 'income').reduce((s,t) => s + t.amount, 0); const monthOut = currentMonthTrans.filter(t => t.type === 'expense').reduce((s,t) => s + t.amount, 0); return { currentMonthTrans, openingBalance, monthIn, monthOut }; }, [trans]);
            const { currentMonthTrans, openingBalance, monthIn, monthOut } = processedData;

            const chartData = useMemo(() => { const list = chartType === 'expense' ? CATEGORIES.expense : CATEGORIES.income; const targetTrans = currentMonthTrans.filter(t => t.type === chartType); const dataMap = {}; list.forEach(c => dataMap[c.label] = { val: 0, color: c.color }); targetTrans.forEach(t => { const cat = list.find(c => c.id === t.category); const label = cat ? cat.label : 'Khác'; const color = cat ? cat.color : '#ccc'; if(!dataMap[label]) dataMap[label] = { val: 0, color }; dataMap[label].val += t.amount; }); const labels = Object.keys(dataMap).filter(k => dataMap[k].val > 0); const values = labels.map(k => dataMap[k].val); const bgColors = labels.map(k => dataMap[k].color); return { labels, values, bgColors }; }, [currentMonthTrans, chartType]);

            useEffect(() => { if(tab === 'dashboard' && chartRef.current) { if(chartInstance.current) chartInstance.current.destroy(); const { labels, values, bgColors } = chartData; if(values.length === 0) { chartInstance.current = new Chart(chartRef.current, { type: 'doughnut', data: { labels: ['Trống'], datasets: [{ data: [1], backgroundColor: ['#f1f5f9'] }] }, options: { cutout: '75%', plugins: { legend: { display: false }, tooltip: { enabled: false } } } }); return; } chartInstance.current = new Chart(chartRef.current, { type: 'doughnut', data: { labels, datasets: [{ data: values, backgroundColor: bgColors, borderWidth: 0, hoverOffset: 4 }] }, options: { responsive: true, cutout: '75%', maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { enabled: true } }, layout: { padding: 0 } } }); } }, [tab, chartData]);

            const loadData = async () => { setLoading(true); try { setTrans(await REAL_API.getTransactions(user.email)); } catch(e) { console.error(e); } finally { setLoading(false); } };
            
            // Sửa lỗi lưu mô tả: Ánh xạ input.desc -> object.description để khớp với Backend
            const saveTrans = async (e) => { 
                e.preventDefault(); 
                const selectedDate = input.date ? new Date(input.date).toISOString() : new Date().toISOString(); 
                const t = { 
                    id: 't'+Date.now(), 
                    amount: parseInt(input.amount), 
                    date: selectedDate,
                    description: input.desc, // <-- FIX: Map desc to description
                    type: input.type,
                    category: input.category
                }; 
                setTrans([t, ...trans]); 
                setInput({ ...input, amount: '', desc: '', date: getCurrentDateTimeLocal() }); 
                try { await REAL_API.addTransaction(user, t); } catch(err) { alert("Lỗi lưu: " + err.message); } 
            };
            
            const removeTrans = async (id) => { if(!confirm("Xóa?")) return; const oldTrans = [...trans]; setTrans(trans.filter(t => t.id !== id)); try { await REAL_API.deleteTransaction(user.email, id); } catch(err) { alert("Lỗi xóa: " + err.message); setTrans(oldTrans); } };

            if(!user) return <AuthScreen onLogin={setUser} />;

            return (
                <div className="flex min-h-screen bg-slate-50 text-gray-800">
                    <aside className="w-64 bg-white border-r hidden md:flex flex-col fixed h-full z-10">
                        <div className="p-6 border-b"><h1 className="text-xl font-bold text-blue-600">Money Tracker</h1></div>
                        <nav className="flex-1 p-4 space-y-2">{navItems.map(i => (<button key={i.id} onClick={()=>setTab(i.id)} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl font-medium transition ${tab===i.id ? 'bg-blue-50 text-blue-600' : 'text-gray-500 hover:bg-gray-50'}`}><Icon name={i.icon} /> {i.label}</button>))}</nav>
                    </aside>
                    <main className="flex-1 md:ml-64 p-4 md:p-8 pb-24">
                        <div className="max-w-4xl mx-auto">
                            <div className="flex justify-between items-center mb-6"><h2 className="text-2xl font-bold capitalize">{navItems.find(i=>i.id===tab)?.label}</h2>{tab !== 'account' && tab !== 'admin' && <button onClick={loadData} className="p-2 rounded-full hover:bg-white shadow-sm text-blue-500 transition">{loading ? <div className="loader"></div> : <Icon name="refresh" />}</button>}</div>
                            {tab === 'dashboard' && <div className="space-y-6 slide-in"><p className="text-sm text-gray-500 italic">*Dữ liệu tháng {currentMonth.getMonth()+1}/{currentMonth.getFullYear()}.</p><div className="grid grid-cols-1 md:grid-cols-3 gap-4"><div className="bg-gradient-to-br from-blue-500 to-blue-600 text-white p-6 rounded-2xl shadow-lg shadow-blue-200"><p className="text-blue-100 text-sm font-medium">Số dư hiện tại</p><p className="text-3xl font-bold mt-1">{formatCurrency(openingBalance + monthIn - monthOut)}</p><p className="text-xs text-blue-200 mt-1 opacity-80">(Đầu kỳ: {formatCurrency(openingBalance)})</p></div><div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100"><p className="text-gray-500 text-sm font-medium">Thu nhập</p><p className="text-2xl font-bold text-emerald-500 mt-1">+{formatCurrency(monthIn)}</p></div><div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100"><p className="text-gray-500 text-sm font-medium">Chi tiêu</p><p className="text-2xl font-bold text-rose-500 mt-1">-{formatCurrency(monthOut)}</p></div></div><div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100"><div className="flex justify-between items-center mb-6"><h3 className="font-bold text-lg">Phân tích tháng này</h3><div className="bg-gray-100 p-1 rounded-lg flex text-sm font-medium"><button onClick={()=>setChartType('expense')} className={`px-4 py-1.5 rounded-md transition ${chartType==='expense'?'bg-white text-rose-500 shadow-sm font-bold':'text-gray-500'}`}>Chi tiêu</button><button onClick={()=>setChartType('income')} className={`px-4 py-1.5 rounded-md transition ${chartType==='income'?'bg-white text-emerald-500 shadow-sm font-bold':'text-gray-500'}`}>Thu nhập</button></div></div><div className="flex flex-col md:flex-row items-center gap-8"><div className="w-full md:w-1/2 h-64 relative flex items-center justify-center"><canvas ref={chartRef}></canvas></div><div className="w-full md:w-1/2 pl-0 md:pl-4"><div className="mb-6 pb-4 border-b border-dashed border-gray-200"><p className="text-gray-500 text-sm font-medium">Tổng {chartType==='expense'?'chi':'thu'}</p><p className={`text-3xl font-bold mt-1 ${chartType==='expense'?'text-rose-500':'text-emerald-500'}`}>{formatCurrency(chartType==='expense'?monthOut:monthIn)}</p></div><div className="space-y-3 max-h-48 overflow-y-auto scrollbar-hide pr-2">{chartData.values.length>0?chartData.labels.map((label,i)=>(<div key={i} className="flex items-center justify-between text-sm group"><div className="flex items-center gap-3"><span className="w-3 h-3 rounded-full ring-2 ring-white shadow-sm" style={{backgroundColor:chartData.bgColors[i]}}></span><span className="text-gray-700 font-medium">{label}</span></div><div className="flex items-center gap-3"><span className="font-semibold text-gray-800">{formatCurrency(chartData.values[i])}</span><span className="text-xs text-gray-400 w-8 text-right">{Math.round((chartData.values[i]/(chartType==='expense'?monthOut:monthIn))*100)}%</span></div></div>)):<p className="text-gray-400 text-sm italic">Chưa có dữ liệu...</p>}</div></div></div></div></div>}
                            {tab === 'add' && <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 max-w-lg mx-auto slide-in"><form onSubmit={saveTrans} className="space-y-5"><div className="grid grid-cols-2 gap-4"><div onClick={()=>setInput({...input,type:'expense'})} className={`p-4 rounded-xl border-2 cursor-pointer text-center transition ${input.type==='expense'?'border-rose-500 bg-rose-50 text-rose-600 font-bold':'border-gray-100 hover:border-gray-200'}`}>Chi tiêu</div><div onClick={()=>setInput({...input,type:'income'})} className={`p-4 rounded-xl border-2 cursor-pointer text-center transition ${input.type==='income'?'border-emerald-500 bg-emerald-50 text-emerald-600 font-bold':'border-gray-100 hover:border-gray-200'}`}>Thu nhập</div></div><div><label className="text-sm font-medium text-gray-700">Số tiền</label><input type="number" required value={input.amount} onChange={e=>setInput({...input,amount:e.target.value})} className="w-full mt-1 p-3 border rounded-xl text-lg font-semibold outline-none focus:ring-2 focus:ring-blue-500" placeholder="0" /></div><div><label className="text-sm font-medium text-gray-700">Ngày & Giờ</label><input type="datetime-local" required value={input.date} onChange={e=>setInput({...input,date:e.target.value})} className="w-full mt-1 p-3 border rounded-xl outline-none focus:ring-2 focus:ring-blue-500" /></div><div><label className="text-sm font-medium text-gray-700">Mô tả</label><input type="text" required value={input.desc} onChange={e=>setInput({...input,desc:e.target.value})} className="w-full mt-1 p-3 border rounded-xl outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ví dụ: Ăn trưa..." /></div><div><label className="text-sm font-medium text-gray-700">Danh mục</label><select value={input.category} onChange={e=>setInput({...input,category:e.target.value})} className="w-full mt-1 p-3 border rounded-xl bg-white outline-none">{(input.type==='expense'?CATEGORIES.expense:CATEGORIES.income).map(c=>(<option key={c.id} value={c.id}>{c.label}</option>))}</select></div><button disabled={loading} className="w-full py-4 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-bold shadow-lg transition transform active:scale-95">{loading?'Đang lưu...':'Lưu giao dịch'}</button></form></div>}
                            {tab === 'history' && <div className="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden slide-in"><div className="overflow-x-auto"><table className="w-full text-left"><thead className="bg-gray-50 border-b border-gray-100 text-gray-500 text-sm"><tr><th className="p-4 font-medium">Thời gian</th><th className="p-4 font-medium">Nội dung</th><th className="p-4 font-medium text-right">Số tiền</th><th className="p-4 text-center">Xóa</th></tr></thead><tbody className="divide-y divide-gray-50">{trans.map(t=>(<tr key={t.id} className="hover:bg-gray-50 transition"><td className="p-4 text-sm text-gray-500">{formatDateTime(t.date)}</td><td className="p-4"><div className="font-medium text-gray-800">{t.description}</div><div className="text-xs text-gray-400 mt-0.5 bg-gray-100 inline-block px-2 py-0.5 rounded-md">{(t.type==='expense'?CATEGORIES.expense:CATEGORIES.income).find(c=>c.id===t.category)?.label||t.category}</div></td><td className={`p-4 text-right font-bold ${t.type==='income'?'text-emerald-600':'text-rose-600'}`}>{t.type==='income'?'+':'-'}{formatCurrency(t.amount)}</td><td className="p-4 text-center"><button onClick={()=>removeTrans(t.id)} className="text-gray-300 hover:text-red-500 transition p-2"><Icon name="trash" size={18}/></button></td></tr>))}{trans.length===0&&<tr><td colSpan="4" className="p-8 text-center text-gray-400">Chưa có dữ liệu</td></tr>}</tbody></table></div></div>}
                            {tab === 'admin' && <AdminTab adminUser={user} />}
                            {tab === 'account' && <AccountTab user={user} setUser={setUser} onLogout={()=>{setUser(null);setTab('dashboard');}} />}
                        </div>
                    </main>
                    <div className="md:hidden fixed bottom-0 inset-x-0 bg-white border-t flex justify-around p-3 z-20 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">{navItems.map(i=>(<button key={i.id} onClick={()=>setTab(i.id)} className={`flex flex-col items-center gap-1 ${tab===i.id?'text-blue-600':'text-gray-400'}`}><Icon name={i.icon} size={24}/><span className="text-[10px] font-medium">{i.label}</span></button>))}</div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>



