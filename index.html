<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Money Tracker Pro</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .slide-in { animation: slideIn 0.3s ease-out forwards; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .vip-card-selected { border: 2px solid #d97706; background-color: #fffbeb; }
        .loader { width: 16px; height: 16px; border: 2px solid #f3f3f3; border-top: 2px solid #3b82f6; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Custom Chart Tooltip styling if needed */
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        // ⚠️ DÁN LINK SCRIPT CỦA BẠN VÀO ĐÂY
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbz1wEkFMo9kO0-TjjSctinSBS8OGdxAm0N0nP1AphXzsSR4oLXFNfDtvbteJd-Ogck0/exec"; 

        const REAL_API = {
            checkUrl: () => {
                if (!GAS_API_URL || GAS_API_URL.length < 10) { alert("Thiếu API URL!"); return false; }
                return true;
            },
            call: async (payload) => {
                if (!REAL_API.checkUrl()) throw new Error("No API");
                const res = await fetch(GAS_API_URL, {
                    method: 'POST', redirect: "follow",
                    headers: { "Content-Type": "text/plain;charset=utf-8" },
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                if (data.status === 'success') return data;
                throw new Error(data.message || "Lỗi API");
            },
            login: async (email, password) => (await REAL_API.call({ action: 'login', email, password })).user,
            register: async (name, email, password, tier) => (await REAL_API.call({ action: 'register', name, email, password, tier })).user,
            addTransaction: async (user, transaction) => await REAL_API.call({ action: 'add_transaction', email: user.email, tier: user.tier, transaction }),
            getTransactions: async (email) => (await REAL_API.call({ action: 'get_transactions', email })).transactions || [],
            deleteTransaction: async (email, id) => await REAL_API.call({ action: 'delete_transaction', email, id })
        };

        const CATEGORIES = {
            expense: [
                { id: 'anuong', label: 'Ăn uống', color: '#ef4444', keywords: ['cafe', 'cơm', 'phở'] },
                { id: 'dichuyen', label: 'Di chuyển', color: '#f97316', keywords: ['xăng', 'xe', 'grab'] },
                { id: 'muasam', label: 'Mua sắm', color: '#f59e0b', keywords: ['quần', 'áo', 'siêu thị'] },
                { id: 'hoadon', label: 'Hóa đơn', color: '#84cc16', keywords: ['điện', 'nước', 'net'] },
                { id: 'giaitri', label: 'Giải trí', color: '#06b6d4', keywords: ['phim', 'game'] },
                { id: 'suckhoe', label: 'Sức khỏe', color: '#8b5cf6', keywords: ['thuốc', 'gym'] },
                { id: 'khac', label: 'Khác', color: '#64748b', keywords: [] }
            ],
            income: [
                { id: 'luong', label: 'Lương', color: '#10b981', keywords: ['lương'] },
                { id: 'thuong', label: 'Thưởng', color: '#3b82f6', keywords: ['thưởng'] },
                { id: 'dautu', label: 'Đầu tư', color: '#6366f1', keywords: ['lãi'] },
                { id: 'khac_in', label: 'Khác', color: '#8b5cf6', keywords: [] }
            ]
        };

        const Icon = ({ name, size = 20, className = "" }) => {
            const icons = {
                home: <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" />,
                plus: <path d="M12 5v14M5 12h14" />,
                clock: <circle cx="12" cy="12" r="10" />,
                settings: <circle cx="12" cy="12" r="3" />,
                trash: <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />,
                pie: <path d="M21.21 15.89A10 10 0 1 1 8 2.83M22 12A10 10 0 0 0 12 2v10z" />,
                refresh: <path d="M23 4v6h-6M1 20v-6h6" />
            };
            return <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{icons[name] || <circle cx="12" cy="12" r="10"/>}</svg>;
        };

        const formatCurrency = (n) => new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(n);

        // --- Auth Component ---
        const AuthScreen = ({ onLogin }) => {
            const [isLogin, setIsLogin] = useState(true);
            const [form, setForm] = useState({ email: '', password: '', name: '', tier: 'free' });
            const [loading, setLoading] = useState(false);
            const [msg, setMsg] = useState('');

            const submit = async (e) => {
                e.preventDefault(); setLoading(true); setMsg('');
                try {
                    const user = isLogin 
                        ? await REAL_API.login(form.email, form.password)
                        : await REAL_API.register(form.name, form.email, form.password, form.tier);
                    onLogin(user);
                } catch (err) { setMsg(err.message); } 
                finally { setLoading(false); }
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-gray-100 p-4">
                    <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md slide-in">
                        <h1 className="text-2xl font-bold text-center mb-6 text-gray-800">Money Tracker</h1>
                        <form onSubmit={submit} className="space-y-4">
                            {!isLogin && <input type="text" placeholder="Họ tên" className="w-full p-3 border rounded-lg" required onChange={e=>setForm({...form, name: e.target.value})}/>}
                            <input type="email" placeholder="Email" className="w-full p-3 border rounded-lg" required onChange={e=>setForm({...form, email: e.target.value})}/>
                            <input type="password" placeholder="Mật khẩu" className="w-full p-3 border rounded-lg" required onChange={e=>setForm({...form, password: e.target.value})}/>
                            {!isLogin && (
                                <div className="grid grid-cols-2 gap-3">
                                    <div onClick={()=>setForm({...form, tier: 'free'})} className={`p-3 border rounded-xl text-center cursor-pointer ${form.tier==='free'?'border-blue-500 bg-blue-50':''}`}>Free</div>
                                    <div onClick={()=>setForm({...form, tier: 'vip'})} className={`p-3 border rounded-xl text-center cursor-pointer ${form.tier==='vip'?'vip-card-selected':''}`}>VIP (50k)</div>
                                </div>
                            )}
                            {msg && <div className="text-red-500 text-sm text-center">{msg}</div>}
                            <button disabled={loading} className="w-full py-3 bg-blue-600 text-white rounded-lg font-bold disabled:opacity-50 flex justify-center">
                                {loading ? <span className="loader"></span> : (isLogin ? 'Đăng nhập' : 'Đăng ký')}
                            </button>
                        </form>
                        <p className="text-center mt-4 text-sm text-blue-600 cursor-pointer hover:underline" onClick={()=>setIsLogin(!isLogin)}>
                            {isLogin ? 'Tạo tài khoản mới' : 'Quay lại đăng nhập'}
                        </p>
                    </div>
                </div>
            );
        };

        // --- Main App ---
        const App = () => {
            const [user, setUser] = useState(() => JSON.parse(localStorage.getItem('user')));
            const [trans, setTrans] = useState([]);
            const [tab, setTab] = useState('dashboard');
            const [loading, setLoading] = useState(false);
            
            // Input State
            const [input, setInput] = useState({ amount: '', desc: '', type: 'expense', category: 'khac' });
            
            // Chart State
            const [chartType, setChartType] = useState('expense');
            const chartRef = useRef(null);
            const chartInstance = useRef(null);

            useEffect(() => {
                if(user) { localStorage.setItem('user', JSON.stringify(user)); loadData(); } 
                else { localStorage.removeItem('user'); setTrans([]); }
            }, [user]);

            // Auto category
            useEffect(() => {
                if(!input.desc) return;
                const list = input.type === 'expense' ? CATEGORIES.expense : CATEGORIES.income;
                const found = list.find(c => c.keywords.some(k => input.desc.toLowerCase().includes(k)));
                if(found) setInput(prev => ({...prev, category: found.id}));
            }, [input.desc, input.type]);

            // Chart Render
            useEffect(() => {
                if(tab === 'dashboard' && chartRef.current) {
                    if(chartInstance.current) chartInstance.current.destroy();
                    
                    const list = chartType === 'expense' ? CATEGORIES.expense : CATEGORIES.income;
                    const currentTrans = trans.filter(t => t.type === chartType);
                    
                    // Group data
                    const dataMap = {};
                    list.forEach(c => dataMap[c.label] = { val: 0, color: c.color });
                    currentTrans.forEach(t => {
                        const cat = list.find(c => c.id === t.category);
                        const label = cat ? cat.label : 'Khác';
                        const color = cat ? cat.color : '#ccc';
                        if(!dataMap[label]) dataMap[label] = { val: 0, color };
                        dataMap[label].val += t.amount;
                    });

                    // Prepare chart data
                    const labels = Object.keys(dataMap).filter(k => dataMap[k].val > 0);
                    const data = labels.map(k => dataMap[k].val);
                    const bgColors = labels.map(k => dataMap[k].color);

                    if(data.length === 0) {
                        // Draw empty chart
                        chartInstance.current = new Chart(chartRef.current, {
                            type: 'doughnut',
                            data: { labels: ['Chưa có dữ liệu'], datasets: [{ data: [1], backgroundColor: ['#f1f5f9'] }] },
                            options: { cutout: '75%', plugins: { legend: { display: false }, tooltip: { enabled: false } } }
                        });
                        return;
                    }

                    chartInstance.current = new Chart(chartRef.current, {
                        type: 'doughnut',
                        data: {
                            labels: labels,
                            datasets: [{
                                data: data,
                                backgroundColor: bgColors,
                                borderWidth: 2,
                                borderColor: '#ffffff',
                                borderRadius: 5, // Bo góc đẹp hơn
                                hoverOffset: 10
                            }]
                        },
                        options: {
                            responsive: true,
                            cutout: '70%', // Mỏng hơn, hiện đại hơn
                            plugins: {
                                legend: {
                                    position: 'right',
                                    labels: { usePointStyle: true, boxWidth: 8, padding: 15, font: { size: 11 } }
                                }
                            },
                            layout: { padding: 10 }
                        }
                    });
                }
            }, [trans, tab, chartType]);

            const loadData = async () => {
                setLoading(true);
                try { setTrans(await REAL_API.getTransactions(user.email)); }
                catch(e) { console.error(e); }
                finally { setLoading(false); }
            };

            const saveTrans = async (e) => {
                e.preventDefault();
                const t = { ...input, id: 't'+Date.now(), amount: parseInt(input.amount), date: new Date().toISOString() };
                setTrans([t, ...trans]); // Optimistic update
                setInput({ ...input, amount: '', desc: '' });
                try { await REAL_API.addTransaction(user, t); } catch(err) { alert("Lỗi lưu: " + err.message); }
            };

            const removeTrans = async (id) => {
                if(!confirm("Xóa giao dịch này?")) return;
                const oldTrans = [...trans];
                setTrans(trans.filter(t => t.id !== id)); // UI update first
                try { await REAL_API.deleteTransaction(user.email, id); } 
                catch(err) { 
                    alert("Lỗi xóa: " + err.message); 
                    setTrans(oldTrans); // Revert if fail
                }
            };

            const totalIn = trans.filter(t => t.type === 'income').reduce((s,t) => s + t.amount, 0);
            const totalOut = trans.filter(t => t.type === 'expense').reduce((s,t) => s + t.amount, 0);

            if(!user) return <AuthScreen onLogin={setUser} />;

            return (
                <div className="flex min-h-screen bg-slate-50 text-gray-800">
                    {/* Sidebar Desktop */}
                    <aside className="w-64 bg-white border-r hidden md:flex flex-col fixed h-full z-10">
                        <div className="p-6 border-b"><h1 className="text-xl font-bold text-blue-600">Money Manager</h1></div>
                        <nav className="flex-1 p-4 space-y-2">
                            {[
                                {id: 'dashboard', label: 'Tổng quan', icon: 'pie'},
                                {id: 'add', label: 'Thêm mới', icon: 'plus'},
                                {id: 'history', label: 'Lịch sử', icon: 'clock'},
                            ].map(i => (
                                <button key={i.id} onClick={()=>setTab(i.id)} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl font-medium transition ${tab===i.id ? 'bg-blue-50 text-blue-600' : 'text-gray-500 hover:bg-gray-50'}`}>
                                    <Icon name={i.icon} /> {i.label}
                                </button>
                            ))}
                        </nav>
                        <div className="p-4 border-t">
                            <div className="flex items-center gap-3 p-2 rounded-lg bg-gray-50">
                                <div className="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 font-bold">{user.name.charAt(0)}</div>
                                <div className="flex-1 min-w-0">
                                    <p className="text-sm font-semibold truncate">{user.name}</p>
                                    <button onClick={()=>setUser(null)} className="text-xs text-red-500 hover:underline">Đăng xuất</button>
                                </div>
                            </div>
                        </div>
                    </aside>

                    {/* Main Content */}
                    <main className="flex-1 md:ml-64 p-4 md:p-8 pb-24">
                        <div className="max-w-4xl mx-auto">
                            <div className="flex justify-between items-center mb-6">
                                <h2 className="text-2xl font-bold capitalize">{tab === 'add' ? 'Giao dịch mới' : tab === 'history' ? 'Lịch sử' : 'Tổng quan'}</h2>
                                <button onClick={loadData} className="p-2 rounded-full hover:bg-white shadow-sm text-blue-500 transition">
                                    {loading ? <div className="loader"></div> : <Icon name="refresh" />}
                                </button>
                            </div>

                            {tab === 'dashboard' && (
                                <div className="space-y-6 slide-in">
                                    {/* Summary Cards */}
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div className="bg-gradient-to-br from-blue-500 to-blue-600 text-white p-6 rounded-2xl shadow-lg shadow-blue-200">
                                            <p className="text-blue-100 text-sm font-medium">Số dư khả dụng</p>
                                            <p className="text-3xl font-bold mt-1">{formatCurrency(totalIn - totalOut)}</p>
                                        </div>
                                        <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                                            <p className="text-gray-500 text-sm font-medium">Tổng thu nhập</p>
                                            <p className="text-2xl font-bold text-emerald-500 mt-1">+{formatCurrency(totalIn)}</p>
                                        </div>
                                        <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                                            <p className="text-gray-500 text-sm font-medium">Tổng chi tiêu</p>
                                            <p className="text-2xl font-bold text-rose-500 mt-1">-{formatCurrency(totalOut)}</p>
                                        </div>
                                    </div>

                                    {/* Chart Section Improved */}
                                    <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                                        <div className="flex justify-between items-center mb-6">
                                            <h3 className="font-bold text-lg">Phân tích tài chính</h3>
                                            <div className="bg-gray-100 p-1 rounded-lg flex text-sm font-medium">
                                                <button 
                                                    onClick={() => setChartType('expense')}
                                                    className={`px-3 py-1.5 rounded-md transition ${chartType === 'expense' ? 'bg-white text-rose-500 shadow-sm' : 'text-gray-500'}`}
                                                >Chi tiêu</button>
                                                <button 
                                                    onClick={() => setChartType('income')}
                                                    className={`px-3 py-1.5 rounded-md transition ${chartType === 'income' ? 'bg-white text-emerald-500 shadow-sm' : 'text-gray-500'}`}
                                                >Thu nhập</button>
                                            </div>
                                        </div>
                                        <div className="h-64 relative flex items-center justify-center">
                                            <canvas ref={chartRef}></canvas>
                                            {/* Center Text for Doughnut */}
                                            <div className="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
                                                <span className="text-xs text-gray-400">Tổng {chartType === 'expense' ? 'chi' : 'thu'}</span>
                                                <span className={`text-lg font-bold ${chartType === 'expense' ? 'text-rose-500' : 'text-emerald-500'}`}>
                                                    {formatCurrency(chartType === 'expense' ? totalOut : totalIn)}
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {tab === 'add' && (
                                <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 max-w-lg mx-auto slide-in">
                                    <form onSubmit={saveTrans} className="space-y-5">
                                        <div className="grid grid-cols-2 gap-4">
                                            <div onClick={()=>setInput({...input, type: 'expense'})} className={`p-4 rounded-xl border-2 cursor-pointer text-center transition ${input.type==='expense' ? 'border-rose-500 bg-rose-50 text-rose-600 font-bold' : 'border-gray-100 hover:border-gray-200'}`}>Chi tiêu</div>
                                            <div onClick={()=>setInput({...input, type: 'income'})} className={`p-4 rounded-xl border-2 cursor-pointer text-center transition ${input.type==='income' ? 'border-emerald-500 bg-emerald-50 text-emerald-600 font-bold' : 'border-gray-100 hover:border-gray-200'}`}>Thu nhập</div>
                                        </div>
                                        <div>
                                            <label className="text-sm font-medium text-gray-700">Số tiền</label>
                                            <input type="number" required value={input.amount} onChange={e=>setInput({...input, amount: e.target.value})} className="w-full mt-1 p-3 border rounded-xl text-lg font-semibold outline-none focus:ring-2 focus:ring-blue-500" placeholder="0" />
                                        </div>
                                        <div>
                                            <label className="text-sm font-medium text-gray-700">Mô tả</label>
                                            <input type="text" required value={input.desc} onChange={e=>setInput({...input, desc: e.target.value})} className="w-full mt-1 p-3 border rounded-xl outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ví dụ: Ăn trưa..." />
                                        </div>
                                        <div>
                                            <label className="text-sm font-medium text-gray-700">Danh mục</label>
                                            <select value={input.category} onChange={e=>setInput({...input, category: e.target.value})} className="w-full mt-1 p-3 border rounded-xl bg-white outline-none">
                                                {(input.type === 'expense' ? CATEGORIES.expense : CATEGORIES.income).map(c => (
                                                    <option key={c.id} value={c.id}>{c.label}</option>
                                                ))}
                                            </select>
                                        </div>
                                        <button disabled={loading} className="w-full py-4 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-bold shadow-lg transition transform active:scale-95">
                                            {loading ? 'Đang lưu...' : 'Lưu giao dịch'}
                                        </button>
                                    </form>
                                </div>
                            )}

                            {tab === 'history' && (
                                <div className="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden slide-in">
                                    <div className="overflow-x-auto">
                                        <table className="w-full text-left">
                                            <thead className="bg-gray-50 border-b border-gray-100 text-gray-500 text-sm">
                                                <tr>
                                                    <th className="p-4 font-medium">Ngày</th>
                                                    <th className="p-4 font-medium">Nội dung</th>
                                                    <th className="p-4 font-medium text-right">Số tiền</th>
                                                    <th className="p-4 text-center">Xóa</th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-gray-50">
                                                {trans.map(t => (
                                                    <tr key={t.id} className="hover:bg-gray-50 transition">
                                                        <td className="p-4 text-sm text-gray-500">{new Date(t.date).toLocaleDateString('vi-VN')}</td>
                                                        <td className="p-4">
                                                            <div className="font-medium text-gray-800">{t.description}</div>
                                                            <div className="text-xs text-gray-400 mt-0.5 bg-gray-100 inline-block px-2 py-0.5 rounded-md">
                                                                {(t.type === 'expense' ? CATEGORIES.expense : CATEGORIES.income).find(c => c.id === t.category)?.label || t.category}
                                                            </div>
                                                        </td>
                                                        <td className={`p-4 text-right font-bold ${t.type==='income'?'text-emerald-600':'text-rose-600'}`}>
                                                            {t.type==='income'?'+':'-'}{formatCurrency(t.amount)}
                                                        </td>
                                                        <td className="p-4 text-center">
                                                            <button onClick={()=>removeTrans(t.id)} className="text-gray-300 hover:text-red-500 transition p-2"><Icon name="trash" size={18}/></button>
                                                        </td>
                                                    </tr>
                                                ))}
                                                {trans.length === 0 && <tr><td colSpan="4" className="p-8 text-center text-gray-400">Chưa có dữ liệu</td></tr>}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            )}
                        </div>
                    </main>

                    {/* Mobile Nav */}
                    <div className="md:hidden fixed bottom-0 inset-x-0 bg-white border-t flex justify-around p-3 z-20 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
                        {['dashboard', 'add', 'history'].map(i => (
                            <button key={i.id} onClick={()=>setTab(i.id)} className={`flex flex-col items-center gap-1 ${tab===i.id ? 'text-blue-600' : 'text-gray-400'}`}>
                                <Icon name={i.icon} size={24} />
                                <span className="text-[10px] font-medium">{i.label}</span>
                            </button>
                        ))}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

